<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>Particle Variable Flow</title>
    <style>
        body {
            color: #ffeec7;
            background-color: #1e1d1b;
            margin: 0;
        }
    </style>
</head>
<body>
    <canvas></canvas>
</body>
<script type="text/javascript">
    class Particle {
        x = 0
        y = 0
        rad = 5
        clr = "red"
        constructor(opts={}, id, stage) {
            Object.assign(this, opts);

            this.id = id;
            this.stage = stage;
            this.sphereArea = 4 * Math.PI * this.rad ** 2;

            this.limX = this.stage.canvas.width;
            this.limY = this.stage.canvas.height;

            this.x = this.x || this.rnd_x;
            this.y = this.y || this.rnd_y;
        }
        next() {
            let velo = this.stage.get_velocities(this);

            this.vx = velo.x;
            this.vy = velo.y;

            this.x += this.vx;
            this.y += this.vy;

            if (this.x - this.rad > this.limX && this.vx >= 0) {
                this.x = 0 - this.rad;
            } else if (this.x + this.rad < 0 && this.vx < 0) {
                this.x = this.limX + this.rad;
            }

            if (this.y - this.rad > this.limY && this.vy >= 0) {
                this.y = 0 - this.rad;
            } else if (this.y + this.rad < 0 && this.vy < 0) {
                this.y = this.limY + this.rad;
            }

            return this
        }
        draw() {
            this.stage.ctx.fillStyle = this.clr || "#ffffff";
            this.stage.ctx.beginPath();
            this.stage.ctx.arc(this.x, this.y, this.rad, 0, 180);
            this.stage.ctx.fill();
        }
        get rnd_x() {
            return Math.ceil(Math.random() * this.limX);
        }
        get rnd_y() {
            return Math.ceil(Math.random() * this.limY);
        }
    }

    class Stage {
        particle_count = 100
        particles = []

        constructor(opts={}) {
            Object.assign(this, opts);
            this.init();
        }

        init() {
            this.particles = [];
            this.ctx = this.canvas.getContext('2d');

            for (let i = 0; i < this.particle_count; i++)
                this.particles.push(new Particle(this.particle_opts, i, this));
        }

        render() {
            this.ctx.globalAlpha = .2;
            this.ctx.fillStyle = '#000000';
            this.ctx.fillRect(0, 0, canvas.width, canvas.height);
            this.ctx.globalAlpha = 1;

            this.particles.forEach(p => {
                p.next().draw();
            });

            this.seeds.forEach(s => {
                this.ctx.strokeStyle = '#ff0000';
                this.ctx.beginPath();
                this.ctx.moveTo(s[0],s[1]);
                this.ctx.lineTo(s[2],s[3]);
                this.ctx.stroke();
                this.ctx.beginPath();
                this.ctx.arc((s[0]+s[2])/2, (s[1]+s[3])/2, Math.hypot(s[2] - s[0], s[3] - s[1])/2, 0, Math.PI*2);
                this.ctx.fillStyle = '#ff0000';
                this.ctx.fillRect(s[2] - 2, s[3] - 2, 4, 4);
                this.ctx.stroke();
            });

            requestAnimationFrame(this.render.bind(this));
        }

        get_velocities(p) {

            let dx = 0, dy = 0;

            this.seeds.forEach(s => {
                let c = [(s[0]+s[2])/2, (s[1]+s[3])/2];
                let inf = [s[2] - s[0], s[3] - s[1]];
                let dist = Math.hypot(p.x - c[0], p.y - c[1]);

                dx += inf[0] / dist;
                dy += inf[1] / dist;
            });

            return { x: dx, y: dy }
        }
    }

    const canvas = document.querySelector('canvas');
    canvas.width = innerWidth*.98;
    canvas.height = innerHeight*.98;

    const stage = new Stage({
        "canvas": canvas,
        "particle_count": 500,
        "seeds": [
            [20,50,50,110],
            [500,300,600,555],
            [1000,120,1200,10],
        ],
        "particle_opts": {
            x: null,
            y: null,
            get rad() {
                return .5;
            },
            get clr() {
                const colors = ["#e10869", "#30ad6f", "#f4782c", "#f7ed9c", "#0e94b2"];
                return "#fff"
            }
        }
    });

    stage.render();
</script>
</html>
